
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="es">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Taller: Integración de R en gvSIG &#8212; documentación de gvSIG Docs - 1.0.0</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/translations.js"></script>
    <script type="text/javascript" src="../../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../../_static/gvSIG.ico"/>
    <link rel="index" title="Índice" href="../../genindex.html" />
    <link rel="search" title="Búsqueda" href="../../search.html" />
    <link rel="next" title="Links" href="../../links.html" />
    <link rel="prev" title="Talleres" href="../index.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Índice General"
             accesskey="I">índice</a></li>
        <li class="right" >
          <a href="../../links.html" title="Links"
             accesskey="N">siguiente</a> |</li>
        <li class="right" >
          <a href="../index.html" title="Talleres"
             accesskey="P">anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">documentación de gvSIG Docs - 1.0.0</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Talleres</a> &#187;</li>

<div align="right">
<li>
<a href="http://downloads.gvsig.org/download/web/es/build/html/index.html"><img src="http://downloads.gvsig.org/download/web/pt_br/build/html/_static/flag_ES.png"></a></li>
<a href="http://downloads.gvsig.org/download/web/en/build/html/index.html"><img src="http://downloads.gvsig.org/download/web/pt_br/build/html/_static/flag_EN.png"></a></li>
<a href="http://downloads.gvsig.org/download/web/pt_br/build/html/index.html"><img src="http://downloads.gvsig.org/download/web/pt_br/build/html/_static/flag_BR.png"></a></li>
</div>

      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="taller-integracion-de-r-en-gvsig">
<h1>Taller: Integración de R en gvSIG<a class="headerlink" href="#taller-integracion-de-r-en-gvsig" title="Enlazar permanentemente con este título">¶</a></h1>
<img alt="../../_images/rtaller.png" src="../../_images/rtaller.png" />
<p>En el siguiente manual, se hace una explicación del contenido dado durante  el taller en las 12as Jornadas de gvSIG, realizadas en la Universidad Politécnica de Valencia.</p>
<div class="section" id="instalacion">
<h2>Instalación<a class="headerlink" href="#instalacion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>El taller está realizado sobre la versión portable de gvSIG para Windows en la versión 2.3.1. Se hace uso de la extensión de R que viene en la instalación con la portable.</p>
<p><a class="reference external" href="http://www.gvsig.com/es/productos/gvsig-desktop/descargas">Descargar gvSIG</a></p>
<p>La extensión de R que utilizaremos, hace uso de una instalación de R que se encuentra dentro de la extensión comentada. También se muestra un ejemplo rápido donde se diferencia la ejecución de Renjin de la de R.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">La extensión de R se encuentra en desarrollo y puedes haber limitaciones de uso en algunas distribuciones. Para cualquier duda os podéis poner en contacto con nosotros a través de las Listas de Usuario y Desarrollo.</p>
</div>
<p>Será necesario descargar un pack de imágenes Landsat previamente recortadas en la zona de estudio. Se ha incluido el recorte de todas las bandas.</p>
<p><a class="reference download internal" href="../../_downloads/data.zip" download=""><code class="xref download docutils literal"><span class="pre">Imágenes</span> <span class="pre">Landsat8</span> <span class="pre">para</span> <span class="pre">Febrero</span> <span class="pre">y</span> <span class="pre">Julio</span> <span class="pre">de</span> <span class="pre">la</span> <span class="pre">zona</span> <span class="pre">de</span> <span class="pre">La</span> <span class="pre">Albufera</span></code></a></p>
</div>
<div class="section" id="introduccion">
<h2>Introducción<a class="headerlink" href="#introduccion" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Durante el taller aprenderemos:
* Mostrar cómo ejecutar scripts en Renjin
* Mostrar cómo ejecutar scripts en R
* Llamar a funciones de R desde un script de Jython
* Pasar parámetros en estas funciones
* Limitaciones de uso</p>
<p>El taller se realiza poniendo como objetivo una aplicación que calcula el <a class="reference external" href="https://es.wikipedia.org/wiki/%C3%8Dndice_de_vegetaci%C3%B3n_de_diferencia_normalizada">NDVI</a> a partir del recorte de 2 imagenes Landsat con sus respectivas bandas en diferentes épocas del año en la zona de la Albufera, aplicando la formula del NDVI entre ellas. El cálculo del NDVI se realizará aplicando directamente la formula del NDVI sobre las imágenes descargadas sin aplicar ninguna otra corrección.</p>
</div>
<div class="section" id="comenzando">
<h2>Comenzando<a class="headerlink" href="#comenzando" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Para comenzar con el taller, lo primero que haremos es ejecutar gvSIG ejecutando el fichero gvsig-desktop.cmd que aparece en la carpeta de la portable. De esta forma se nos abrirá una consola junto a gvSIG que nos será de utilidad para realizar tareas de desarrollo.</p>
<p>Una vez abierto gvSIG, crearemos una Vista nueva. Con la Vista seleccionada en el Gestor de Proyectos, en las Propiedades de la Vista <strong>cambiaremos la proyección a EPSG:32630</strong>, ya que las imágenes Landsat del recorte vienen en esta proyección.</p>
<img alt="../../_images/1.png" src="../../_images/1.png" />
<img alt="../../_images/2.png" src="../../_images/2.png" />
<img alt="../../_images/3.png" src="../../_images/3.png" />
<img alt="../../_images/4.png" src="../../_images/4.png" />
<img alt="../../_images/5.png" src="../../_images/5.png" />
<p>Lo siguiente que haremos será cargar los datos necesarios en la Vista, a los cuales hacemos referencia desde código. En este caso <strong>añadiremos 4 imagenes</strong>, referentes a las bandas Roja y Infrarroja de dos imagenes Landsat, una tomada en Febrero y otra en Julio del 2016.</p>
<p>Capas a cargar en la Vista:
* feb_B4.tif
* feb_B5.tif
* jul_B4.tif
* jul_B5.tif</p>
<p>Para hacerlo podemos irnos al botón de <strong>Agregar capas</strong>.</p>
<img alt="../../_images/6.png" src="../../_images/6.png" />
<p>También es posible arrastrando directamente desde el Explorador a gvSIG.</p>
<p>Cuando nos muestre la forma de cargas las capas, podemos darle a <strong>Todas normal</strong>.</p>
<img alt="../../_images/7.png" src="../../_images/7.png" />
<img alt="../../_images/8.png" src="../../_images/8.png" />
<p>Quedando como resultado de nuestra Vista:</p>
<img alt="../../_images/9.png" src="../../_images/9.png" />
</div>
<div class="section" id="estructura-del-proyecto">
<h2>Estructura del proyecto<a class="headerlink" href="#estructura-del-proyecto" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Con los datos iniciales preparados vamos a pasar a la parte de programación.</p>
<p>Vamos en el menú a Herramientas -&gt; Scripting -&gt; Editor de Scripts.</p>
<img alt="../../_images/110.png" src="../../_images/110.png" />
<p>Se nos abrirá el Scripting Composer o Editor de Scripts. Desde aquí tenemos todo lo necesario para la creación y ejecución de Scripts.</p>
<img alt="../../_images/111.png" src="../../_images/111.png" />
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Este taller trata sobre la ejecución de R desde scripting. Si buscas más información sobre el Módulo de Scripting puedes consultar la documentación especifica del Módulo.</p>
</div>
<p>Lo primero será crear una carpeta que contenga nuestro módulo, en el incluiremos los scripts creados y también podríamos incluir las imágenes para hacer referencia a ellas directamente desde nuestro script de forma relativa y no haciendo referencia a las cargadas en la Vista. Durante este taller hacemos referencia a las insertadas en la Vista para facilitar el código explicado. La ventaja de tener todo contenido en una carpeta es que gvSIG nos permitirá empaquetar nuestro módulo en un paquete que podremos distribuir de forma sencilla a otros usuarios.</p>
<p>Continuando con la creación del módulo nuevo, vamos a irnos al botón de <em>Nuevo</em> y vamos a crear una Carpeta denominada: «taller-12jornadas-r». Seleccionamos el Type Folder, y la localización de dónde queremos crearla, en este caso, en el raíz:</p>
<img alt="../../_images/112.png" src="../../_images/112.png" />
<img alt="../../_images/113.png" src="../../_images/113.png" />
<p>Vemos que ya nos aparecerá en la estructura de scripts:</p>
<img alt="../../_images/114.png" src="../../_images/114.png" />
<p>Ahora crearemos una carpeta denominada <em>data</em> dentro de esta carpeta, repitiendo el proceso anterior, solo teniendo en cuenta de crearla dentro de la carpeta anterior:</p>
<img alt="../../_images/115.png" src="../../_images/115.png" />
<img alt="../../_images/116.png" src="../../_images/116.png" />
<p>Lo siguiente será crear dos scripts. El primero denominado «ejemplo» de lenguaje Python dentro de la carpeta /taller-12jornadas-r/.</p>
<img alt="../../_images/117.png" src="../../_images/117.png" />
<p>El segundo denominado «rejemplo» de lenguaje R dentro de la carpeta <strong>data</strong>:</p>
<img alt="../../_images/118.png" src="../../_images/118.png" />
<p>Quedando como resultado la siguiente estructura de datos con los dos scripts ya abiertos en nuestro Editor:</p>
<img alt="../../_images/119.png" src="../../_images/119.png" />
</div>
<div class="section" id="librerias-de-r">
<h2>Librerías de R<a class="headerlink" href="#librerias-de-r" title="Enlazar permanentemente con este título">¶</a></h2>
<p>La instalación de R que viene con gvSIG, viene por defecto con diversas librerías de uso común en nuestro ámbito. En caso de que fuera necesario instalar otras librerías se puede realizar mediante una consola que abriremos desde el Editor de Scripts.</p>
<p>Para ello vamos a ir a la pestaña de Sistema que se encuentra dentro del Editor. En esta pestaña encontraremos ficheros de ejemplo y de configuración relacionados con scripting que se encuentran en diferentes módulos de gvSIG. En nuestro caso, accederemos al módulo de R y al abrirlo veremos que aparece un script denominado RShell, si hacemos doble click, aparecerá abierto en el editor:</p>
<img alt="../../_images/120.png" src="../../_images/120.png" />
<p>Para ejecutarlo debemos dar a <strong>F5</strong> o sobre el botón de <strong>Guardar y ejecutar</strong>:</p>
<img alt="../../_images/121.png" src="../../_images/121.png" />
<p>Veremos como se nos aparece una consola similar a la siguiente:</p>
<p>Esta consola es la consola de R que hace referencia a la instalación que viene dentro de nuestra extensión de R. No confundirla con la instalación de nuestro sistema.</p>
<img alt="../../_images/122.png" src="../../_images/122.png" />
<p>Las librerías instaladas desde esta consola, serán accesibles desde nuestros scripts en R.</p>
<p>Por ejemplo, vamos a ver a instalar la librería rasterVis se la siguiente forma:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">install</span><span class="o">.</span><span class="n">packages</span><span class="p">(</span><span class="s2">&quot;rasterVis&quot;</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../../_images/123.png" src="../../_images/123.png" />
<img alt="../../_images/124.png" src="../../_images/124.png" />
<p>Como vemos ya estaría instalada y accesible.</p>
<p>Para este taller haremos uso exclusivo de la librería de R: «raster»</p>
<p>Ya podemos cerrar la consola y seguiremos con nuestros scripts.</p>
</div>
<div class="section" id="llamando-funciones-de-r">
<h2>Llamando funciones de R<a class="headerlink" href="#llamando-funciones-de-r" title="Enlazar permanentemente con este título">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Algunas de las siguientes funciones de acceso a R es posible que sufran algunas modificaciones menores para facilitar su ejecución.</p>
</div>
<p>El código siguiente es lo mínimo necesario para le ejecución de una función en R. Se va explicando en los comentarios del código el significado de cada línea de código:</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Recordar de siempre guardar cada vez que modifiquemos un script. Si la pestaña del script aparece en negrita significa que no está guardado. Sobretodo en este taller tendremos que tener cuidado al ejecutar el código del script ejemplo, ya que al hacer referencia al código rejemplo, si este último no se encuentra guardado, no podremos notar los cambios.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Remarcar, que siempre que ejecutemos el script, deberemos de estar en la pestaña del script que hace referencia a ejemplo.py. Si ejecutamos desde rejemplo.r, estaríamos utilizando el motor de Renjin.</p>
</div>
<p>Script ejemplo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># encoding: utf-8</span>

<span class="kn">import</span> <span class="nn">gvsig</span>
<span class="kn">import</span> <span class="nn">rlib</span>

<span class="k">def</span> <span class="nf">console</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">otype</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">msg</span><span class="p">,</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="c1">#Lanzamos el motor de R</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">rlib</span><span class="o">.</span><span class="n">getREngine</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>

    <span class="c1"># Estableciendo el directorio de trabajo dentro de R haciendo</span>
    <span class="c1"># referencia a la carpeta data creada anteriormente</span>
    <span class="n">R</span><span class="o">.</span><span class="n">setwd</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">gvsig</span><span class="o">.</span><span class="n">getResource</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)))</span>

    <span class="c1"># Cargamos el codigo de R generado</span>
    <span class="n">R</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">gvsig</span><span class="o">.</span><span class="n">getResource</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="s2">&quot;rejemplo.r&quot;</span><span class="p">)))</span>

    <span class="c1"># Llamamos a la funcion deseada dentro del codigo de R</span>
    <span class="n">R</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;mytest&quot;</span><span class="p">)</span>

    <span class="c1"># Finalizamos el motor de R</span>
    <span class="n">R</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
</pre></div>
</div>
<p>Vemos como hace referencia de forma relativa al código de rejemplo.r que se encuentra dentro del mismo módulo que hemos creado anteriormente haciendo uso de la función <cite>gvsig.getResource</cite>.</p>
<p>La función de R.getPathName nos ayudará a conseguir rutas de ficheros como capas raster (lo veremos más adelante), pero en este caso, nos ayuda a corregir la ruta del fichero que obtenemos con getResource. Esto viene porque el lenguaje R solo acepta que las rutas hagan uso de las barras «/» en sus string. Con esta formula nos aseguramos de convertirlas a este tipo.</p>
<p>Para ejecutar el código de R, lo que se hace es cargarlo con la función R.source(), para luego acceder a él mediante R.call(). En este caso vamos a ir a la pestaña de «rejemplo» a modificar la función que viene predeterminada en gvSIG por su nombre «mytest». Una vez modificado, recordar siempre de guardar el script.</p>
<p>Quedaría así.</p>
<p>Script de rejemplo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">mytest</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">cat</span><span class="p">(</span> <span class="s2">&quot;Hello</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Vemos la ejecución del script por consola:</p>
<img alt="../../_images/125.png" src="../../_images/125.png" />
</div>
<div class="section" id="pasando-parametros-a-las-funciones">
<h2>Pasando parámetros a las funciones<a class="headerlink" href="#pasando-parametros-a-las-funciones" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Algo que nos hará falta con seguridad es el pasar parámetros a las funciones de R. En nuestro caso, dada las limitaciones que ofrece la interacción entre Jython y R, solo podemos pasarle parámetros de texto.</p>
<p>Por ejemplo, vamos a ver como pasarle una ruta de una capa cargada en gvSIG.</p>
<p>Para ello, al código anterior, vamos a añadir el acceso a una de las imágenes cargadas anteriormente.</p>
<p>Script ejemplo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># encoding: utf-8</span>

<span class="kn">import</span> <span class="nn">gvsig</span>
<span class="kn">import</span> <span class="nn">rlib</span>

<span class="k">def</span> <span class="nf">console</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">otype</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">msg</span><span class="p">,</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">rlib</span><span class="o">.</span><span class="n">getREngine</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
    <span class="c1"># Caso de que la capa se encontrara en carpeta data</span>
    <span class="c1">#b4_path = gvsig.getResource(__file__, &quot;data&quot;, &quot;feb_B4.tif&quot;)</span>

    <span class="c1"># Caso de una capa cargada en una Vista de gvSIG</span>
    <span class="n">b4</span> <span class="o">=</span> <span class="n">gvsig</span><span class="o">.</span><span class="n">currentView</span><span class="p">()</span><span class="o">.</span><span class="n">getLayer</span><span class="p">(</span><span class="s2">&quot;feb_B4&quot;</span><span class="p">)</span>

    <span class="c1"># La funcion getPathName se encarga de extraer el path por nosotros</span>
    <span class="n">b4_path</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">b4</span><span class="p">)</span>

    <span class="n">R</span><span class="o">.</span><span class="n">setwd</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">gvsig</span><span class="o">.</span><span class="n">getResource</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)))</span>
    <span class="n">R</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">gvsig</span><span class="o">.</span><span class="n">getResource</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="s2">&quot;rejemplo.r&quot;</span><span class="p">)))</span>
    <span class="c1"># Agregamos un parametro a la funcion</span>
    <span class="n">R</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;mytest&quot;</span><span class="p">,</span> <span class="n">b4_path</span><span class="p">)</span>
    <span class="n">R</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
</pre></div>
</div>
<p>Script rejemplo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Agregamos un parametro a la funcion</span>
<span class="n">mytest</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">b4_path</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">cat</span><span class="p">(</span> <span class="s2">&quot;Capa: &quot;</span><span class="p">,</span> <span class="n">b4_path</span> <span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
<p>En el resultado podemos ver como muestra la ruta de la capa:</p>
<img alt="../../_images/126.png" src="../../_images/126.png" />
</div>
<div class="section" id="calculo-de-histograma">
<h2>Calculo de histograma<a class="headerlink" href="#calculo-de-histograma" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Una opción que podríamos querer es el cálculo de un histograma de una imagen raster. Para ello, basándonos en el script anterior (en el cual ya le pasamos una ruta de un raster al código R), vamos a aprovechar para hacer uso de la función hist() perteneciente a la librería «raster».</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Tener cuidado de no crear funciones de R con el mismo nombre que funciones de sus librerías, ya que de esa forma pueden entrar en conflicto.</p>
</div>
<p>Modificaremos el código de R con el siguiente:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">histograma</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">b4_path</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1"># Cargamos la libreria</span>
    <span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
    <span class="c1"># Cargamos la capa desde la ruta</span>
    <span class="n">b4</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">b4_path</span><span class="p">)</span>
    <span class="c1"># Forzamos la apertura de la ventana</span>
    <span class="n">x11</span><span class="p">()</span>
    <span class="c1"># Ejecutamos la funcion de histograma</span>
    <span class="n">hist</span><span class="p">(</span><span class="n">b4</span><span class="p">)</span>
    <span class="c1"># Esperamos a cerrar el ultimo plot para continuar su ejecucion</span>
    <span class="n">locator</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="p">}</span>
</pre></div>
</div>
<p>Ya que hemos cambiado el nombre de la función, modificamos la línea correspondiente en el script de ejemplo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">R</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;histograma&quot;</span><span class="p">,</span> <span class="n">b4_path</span><span class="p">)</span>
</pre></div>
</div>
<p>El resultado esperado será algo similar a:</p>
<img alt="../../_images/127.png" src="../../_images/127.png" />
<p>Una de las diferencias de ejecutar código de R de esta forma respecto a, por ejemplo, desde RStudio, es que para mostrar las gráficas (plots) debemos de forzar la salida de la ventana y su espera para su correcta visualización. Esto se consigue mediante x11() y locator(). x11() nos abre una ventana correspondiente al plot, y locator nos obliga a esperar el cierre del plot para continuar con la ejecución del programa.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">La mayor parte de las funciones que aparecen en este taller como hist(), x11() y otras, tienen una gran cantidad de parámetros extra que se pueden establecer para modificar su comportamiento a la hora de ejecutarse. Estos parámetros los puedes encontrar buscando directamente en Google y accediendo a la documentación correspondiente de las librerías de R.</p>
</div>
</div>
<div class="section" id="calculo-del-ndvi">
<h2>Calculo del NDVI<a class="headerlink" href="#calculo-del-ndvi" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Para realizar el cálculo del NDVI vamos a realizar una pequeña reestructuración de nuestro código que nos facilitará las cosas. Por el resto, contendrá lo mismo que lo enseñado anteriormente, se le pasarán dos parámetros a las funciones de R en vez de uno, y se creará una función de ejemplo que será llamada desde la función principal main().</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">En este ejemplo eliminamos la línea R.setwd ya que no estamos utilizándola realmente desde R. También podría ser establecida desde nuestro código de R.</p>
</div>
<p>Vamos a ver cómo quedaría:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># encoding: utf-8</span>

<span class="kn">import</span> <span class="nn">gvsig</span>
<span class="kn">import</span> <span class="nn">rlib</span>

<span class="k">def</span> <span class="nf">console</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">otype</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">msg</span><span class="p">,</span>

<span class="k">def</span> <span class="nf">calculo</span><span class="p">(</span><span class="n">b4_name</span><span class="p">,</span> <span class="n">b5_name</span><span class="p">,</span> <span class="n">ndvi_func</span><span class="p">,</span> <span class="n">ndvi_name</span><span class="p">):</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">rlib</span><span class="o">.</span><span class="n">getREngine</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>

    <span class="c1"># Path desde la capa y corregido</span>
    <span class="n">b4</span> <span class="o">=</span> <span class="n">gvsig</span><span class="o">.</span><span class="n">currentView</span><span class="p">()</span><span class="o">.</span><span class="n">getLayer</span><span class="p">(</span><span class="n">b4_name</span><span class="p">)</span>
    <span class="n">b5</span> <span class="o">=</span> <span class="n">gvsig</span><span class="o">.</span><span class="n">currentView</span><span class="p">()</span><span class="o">.</span><span class="n">getLayer</span><span class="p">(</span><span class="n">b5_name</span><span class="p">)</span>

    <span class="c1">#Parametros</span>
    <span class="n">b4_path</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">b4</span><span class="p">)</span>
    <span class="n">b5_path</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">b5</span><span class="p">)</span>
    <span class="n">ndvi_path</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">gvsig</span><span class="o">.</span><span class="n">getTempFile</span><span class="p">(</span><span class="s2">&quot;ndvi&quot;</span><span class="p">,</span> <span class="s2">&quot;.tif&quot;</span><span class="p">))</span>

    <span class="n">R</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">gvsig</span><span class="o">.</span><span class="n">getResource</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;rejemplo.r&quot;</span><span class="p">)))</span>
    <span class="n">R</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ndvi_func</span><span class="p">,</span> <span class="n">b4_path</span><span class="p">,</span> <span class="n">b5_path</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">)</span>
    <span class="n">R</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">gvsig</span><span class="o">.</span><span class="n">loadRasterFile</span><span class="p">(</span><span class="n">ndvi_path</span><span class="p">)</span>
    <span class="n">r1</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">ndvi_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ndvi_path</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">feb</span> <span class="o">=</span> <span class="n">calculo</span><span class="p">(</span><span class="s2">&quot;feb_B4&quot;</span><span class="p">,</span> <span class="s2">&quot;feb_B5&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi-feb&quot;</span><span class="p">)</span>
    <span class="n">jul</span> <span class="o">=</span> <span class="n">calculo</span><span class="p">(</span><span class="s2">&quot;jul_B4&quot;</span><span class="p">,</span> <span class="s2">&quot;jul_B5&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi-jul&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Y en R:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ndvi</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">b4_path</span><span class="p">,</span> <span class="n">b5_path</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
  <span class="n">b4</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">b4_path</span><span class="p">)</span>
  <span class="n">b5</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">b5_path</span><span class="p">)</span>
  <span class="n">ndvi</span> <span class="o">&lt;-</span> <span class="n">overlay</span><span class="p">(</span><span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">fun</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="n">writeRaster</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Con la función gvsig.getTempFile(nombre, extension), estamos obteniendo una ruta temporal para la capa que se creará en R y la cual pasamos como parámetro. Esta función se utiliza para evitar la introducción de un nombre de capa fijo, el cual puede dar problemas al ejecutar el script por segunda vez y que al encontrar que ya existe una capa con el mismo nombre, nos aparezca un error y se cancele la ejecución.</p>
<p>En el código de R podríamos tener diferentes funciones incluidas al mismo tiempo, ya que en el R.call(nombre), es donde indicamos qué función ejecutar.</p>
<p>Para el cálculo del ndvi hacemos uso de la función overlay que viene en la librería de raster. Esta función nos permite mezclar dos raster respecto a una función introducida. En nuestro caso, esta función será la fórmula del cálculo del NDVI. Para  un correcto funcionamiento y rápido de este código (con motivo de ser un taller), los recortes de los raster deben de ser del mismo tamaño y zona.</p>
<img alt="../../_images/130.png" src="../../_images/130.png" />
<p>Después de la ejecución del código, veremos como en nuestra Vista se han cargado dos capas raster, correspondientes al ndvi de Febrero y de Julio.</p>
<img alt="../../_images/128.png" src="../../_images/128.png" />
<img alt="../../_images/129.png" src="../../_images/129.png" />
<p>El NDVI siempre viene con un rango de -1 a 1 así que vamos a darle una correcta tabla de color.</p>
<p>Para ello, click derecho sobre la imagen seleccionada y vamos al menu de Tablas de Color:</p>
<img alt="../../_images/131.png" src="../../_images/131.png" />
<p>Seleccionaremos la Librería que aparece en segundo lugar de «Soil - Forest». Activaremos la opción abajo a la izquierda de Tablas de color, y vamos a ajustar los límites diciéndole los valores de -1 a 1. Después de esto, aplicaremos y aceptaremos. Repetiremos el proceso con la otra imagen. Nos dará como resultado algo como lo siguiente:</p>
<img alt="../../_images/132.png" src="../../_images/132.png" />
<img alt="../../_images/133.png" src="../../_images/133.png" />
<img alt="../../_images/134.png" src="../../_images/134.png" />
<p>En las imágenes ya podemos apreciar cómo en Julio, cuando el arroz está florecido en la zona de La Albufera, se aprecian unos indices de vegetación más altos. Por contra, apenas se nota nada en la imagen de Febrero, cuando el arroz no está plantado.</p>
<p>Para visualizar mejor la diferencia entre las dos épocas, vamos a hacer una resta de las dos imagenes resultado. Vamos a aprovecharnos de lo que ya tenemos.</p>
<p>Por ejemplo, vemos en nuestro código que en la función <cite>calculo</cite> devolvemos el path de la imagen resultante, de esta forma podemos utilizarla de nuevo. Además, los parámetros que utilizamos son los mismos que en el anterior, dos capas raster y una de salida, así que reutilizaremos también la función de <cite>calculo</cite>, solo crearemos una nueva función en R. La función en R será la misma que la del ndvi, solo modificaremos la fórmula a usar en la función overlay.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Para poder realizar esto con facilidad, hemos tenido en cuenta en renombrar las imágenes cada vez que las cargamos en la Vista con un nombre fácil de acceder.</p>
</div>
<p>Quedando así el script ejemplo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># encoding: utf-8</span>

<span class="kn">import</span> <span class="nn">gvsig</span>
<span class="kn">import</span> <span class="nn">rlib</span>

<span class="k">def</span> <span class="nf">console</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">otype</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">msg</span><span class="p">,</span>

<span class="k">def</span> <span class="nf">calculo</span><span class="p">(</span><span class="n">b4_name</span><span class="p">,</span> <span class="n">b5_name</span><span class="p">,</span> <span class="n">ndvi_func</span><span class="p">,</span> <span class="n">ndvi_name</span><span class="p">):</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">rlib</span><span class="o">.</span><span class="n">getREngine</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>

    <span class="c1"># Path desde la capa y corregido</span>
    <span class="n">b4</span> <span class="o">=</span> <span class="n">gvsig</span><span class="o">.</span><span class="n">currentView</span><span class="p">()</span><span class="o">.</span><span class="n">getLayer</span><span class="p">(</span><span class="n">b4_name</span><span class="p">)</span>
    <span class="n">b5</span> <span class="o">=</span> <span class="n">gvsig</span><span class="o">.</span><span class="n">currentView</span><span class="p">()</span><span class="o">.</span><span class="n">getLayer</span><span class="p">(</span><span class="n">b5_name</span><span class="p">)</span>

    <span class="c1">#Parametros</span>
    <span class="n">b4_path</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">b4</span><span class="p">)</span>
    <span class="n">b5_path</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">b5</span><span class="p">)</span>
    <span class="n">ndvi_path</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">gvsig</span><span class="o">.</span><span class="n">getTempFile</span><span class="p">(</span><span class="s2">&quot;ndvi&quot;</span><span class="p">,</span> <span class="s2">&quot;.tif&quot;</span><span class="p">))</span>

    <span class="n">R</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">gvsig</span><span class="o">.</span><span class="n">getResource</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;rejemplo.r&quot;</span><span class="p">)))</span>
    <span class="n">R</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ndvi_func</span><span class="p">,</span> <span class="n">b4_path</span><span class="p">,</span> <span class="n">b5_path</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">)</span>
    <span class="n">R</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">gvsig</span><span class="o">.</span><span class="n">loadRasterFile</span><span class="p">(</span><span class="n">ndvi_path</span><span class="p">)</span>
    <span class="n">r1</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">ndvi_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ndvi_path</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">feb</span> <span class="o">=</span> <span class="n">calculo</span><span class="p">(</span><span class="s2">&quot;feb_B4&quot;</span><span class="p">,</span> <span class="s2">&quot;feb_B5&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi-feb&quot;</span><span class="p">)</span>
    <span class="n">jul</span> <span class="o">=</span> <span class="n">calculo</span><span class="p">(</span><span class="s2">&quot;jul_B4&quot;</span><span class="p">,</span> <span class="s2">&quot;jul_B5&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi-jul&quot;</span><span class="p">)</span>
    <span class="n">dif</span> <span class="o">=</span> <span class="n">calculo</span><span class="p">(</span><span class="s2">&quot;ndvi-feb&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi-jul&quot;</span><span class="p">,</span> <span class="s2">&quot;diferencia&quot;</span><span class="p">,</span> <span class="s2">&quot;diferencia&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Y el script de rejemplo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ndvi</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">b4_path</span><span class="p">,</span> <span class="n">b5_path</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
  <span class="n">b4</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">b4_path</span><span class="p">)</span>
  <span class="n">b5</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">b5_path</span><span class="p">)</span>
  <span class="n">ndvi</span> <span class="o">&lt;-</span> <span class="n">overlay</span><span class="p">(</span><span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">fun</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="n">writeRaster</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">diferencia</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">b4_path</span><span class="p">,</span> <span class="n">b5_path</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
  <span class="n">b4</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">b4_path</span><span class="p">)</span>
  <span class="n">b5</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">b5_path</span><span class="p">)</span>
  <span class="n">ndvi</span> <span class="o">&lt;-</span> <span class="n">overlay</span><span class="p">(</span><span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">fun</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="n">writeRaster</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Dando como resultado una imagen que si le aplicamos una tabla de color veremos dónde se han producido las mayores diferencias en las imágenes correspondientes al NDVI entre Febrero y Julio:</p>
<img alt="../../_images/135.png" src="../../_images/135.png" />
<p>Otra forma de visualizar estas imágenes sería mediante un rasterstack, para ello hacemos lo mismo, agregamos una función nueva según nuestras necesidades.</p>
<p>Script ejemplo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1"># encoding: utf-8</span>

<span class="kn">import</span> <span class="nn">gvsig</span>
<span class="kn">import</span> <span class="nn">rlib</span>

<span class="k">def</span> <span class="nf">console</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">otype</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">msg</span><span class="p">,</span>

<span class="k">def</span> <span class="nf">calculo</span><span class="p">(</span><span class="n">b4_name</span><span class="p">,</span> <span class="n">b5_name</span><span class="p">,</span> <span class="n">ndvi_func</span><span class="p">,</span> <span class="n">ndvi_name</span><span class="p">):</span>

    <span class="n">R</span> <span class="o">=</span> <span class="n">rlib</span><span class="o">.</span><span class="n">getREngine</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>

    <span class="c1"># Path desde la capa y corregido</span>
    <span class="n">b4</span> <span class="o">=</span> <span class="n">gvsig</span><span class="o">.</span><span class="n">currentView</span><span class="p">()</span><span class="o">.</span><span class="n">getLayer</span><span class="p">(</span><span class="n">b4_name</span><span class="p">)</span>
    <span class="n">b5</span> <span class="o">=</span> <span class="n">gvsig</span><span class="o">.</span><span class="n">currentView</span><span class="p">()</span><span class="o">.</span><span class="n">getLayer</span><span class="p">(</span><span class="n">b5_name</span><span class="p">)</span>

    <span class="c1">#Parametros</span>
    <span class="n">b4_path</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">b4</span><span class="p">)</span>
    <span class="n">b5_path</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">b5</span><span class="p">)</span>
    <span class="n">ndvi_path</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">gvsig</span><span class="o">.</span><span class="n">getTempFile</span><span class="p">(</span><span class="s2">&quot;ndvi&quot;</span><span class="p">,</span> <span class="s2">&quot;.tif&quot;</span><span class="p">))</span>

    <span class="n">R</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">gvsig</span><span class="o">.</span><span class="n">getResource</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;rejemplo.r&quot;</span><span class="p">)))</span>
    <span class="n">R</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">ndvi_func</span><span class="p">,</span> <span class="n">b4_path</span><span class="p">,</span> <span class="n">b5_path</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">)</span>
    <span class="n">R</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

    <span class="n">r1</span> <span class="o">=</span> <span class="n">gvsig</span><span class="o">.</span><span class="n">loadRasterFile</span><span class="p">(</span><span class="n">ndvi_path</span><span class="p">)</span>
    <span class="n">r1</span><span class="o">.</span><span class="n">setName</span><span class="p">(</span><span class="n">ndvi_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ndvi_path</span>

<span class="k">def</span> <span class="nf">rasterstack</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">):</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">rlib</span><span class="o">.</span><span class="n">getREngine</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
    <span class="n">R</span><span class="o">.</span><span class="n">source</span><span class="p">(</span><span class="n">R</span><span class="o">.</span><span class="n">getPathName</span><span class="p">(</span><span class="n">gvsig</span><span class="o">.</span><span class="n">getResource</span><span class="p">(</span><span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;rejemplo.r&quot;</span><span class="p">)))</span>
    <span class="n">R</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;rasterstack&quot;</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">)</span>
    <span class="n">R</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="n">feb</span> <span class="o">=</span> <span class="n">calculo</span><span class="p">(</span><span class="s2">&quot;feb_B4&quot;</span><span class="p">,</span> <span class="s2">&quot;feb_B5&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi-feb&quot;</span><span class="p">)</span>
    <span class="n">jul</span> <span class="o">=</span> <span class="n">calculo</span><span class="p">(</span><span class="s2">&quot;jul_B4&quot;</span><span class="p">,</span> <span class="s2">&quot;jul_B5&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi-jul&quot;</span><span class="p">)</span>
    <span class="n">dif</span> <span class="o">=</span> <span class="n">calculo</span><span class="p">(</span><span class="s2">&quot;ndvi-feb&quot;</span><span class="p">,</span> <span class="s2">&quot;ndvi-jul&quot;</span><span class="p">,</span> <span class="s2">&quot;diferencia&quot;</span><span class="p">,</span> <span class="s2">&quot;diferencia&quot;</span><span class="p">)</span>
    <span class="c1"># siendo los siguientes parametros las rutas de las imagenes resultado</span>
    <span class="n">rasterstack</span><span class="p">(</span><span class="n">feb</span><span class="p">,</span> <span class="n">jul</span><span class="p">,</span> <span class="n">dif</span><span class="p">)</span>
</pre></div>
</div>
<p>Script rejemplo:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ndvi</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">b4_path</span><span class="p">,</span> <span class="n">b5_path</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
  <span class="n">b4</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">b4_path</span><span class="p">)</span>
  <span class="n">b5</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">b5_path</span><span class="p">)</span>
  <span class="n">ndvi</span> <span class="o">&lt;-</span> <span class="n">overlay</span><span class="p">(</span><span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">fun</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">y</span><span class="o">+</span><span class="n">x</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="n">writeRaster</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">diferencia</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">b4_path</span><span class="p">,</span> <span class="n">b5_path</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
  <span class="n">b4</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">b4_path</span><span class="p">)</span>
  <span class="n">b5</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">b5_path</span><span class="p">)</span>
  <span class="n">ndvi</span> <span class="o">&lt;-</span> <span class="n">overlay</span><span class="p">(</span><span class="n">b4</span><span class="p">,</span> <span class="n">b5</span><span class="p">,</span> <span class="n">fun</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
      <span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
  <span class="p">})</span>
  <span class="n">writeRaster</span><span class="p">(</span><span class="n">ndvi</span><span class="p">,</span> <span class="n">ndvi_path</span><span class="p">,</span> <span class="nb">format</span> <span class="o">=</span> <span class="s2">&quot;GTiff&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">rasterstack</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">r1_path</span><span class="p">,</span> <span class="n">r2_path</span><span class="p">,</span> <span class="n">r3_path</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>
  <span class="n">r1</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">r1_path</span><span class="p">)</span>
  <span class="n">r2</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">r2_path</span><span class="p">)</span>
  <span class="n">r3</span> <span class="o">&lt;-</span> <span class="n">raster</span><span class="p">(</span><span class="n">r3_path</span><span class="p">)</span>
  <span class="n">s1</span> <span class="o">&lt;-</span> <span class="n">stack</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">r3</span><span class="p">)</span>
  <span class="n">x11</span><span class="p">()</span>
  <span class="n">plot</span><span class="p">(</span><span class="n">s1</span><span class="p">)</span>
  <span class="n">locator</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Dando como resultado un plot con las siguientes imagenes:</p>
<img alt="../../_images/136.png" src="../../_images/136.png" />
<p>Este plot podría ser guardado en formato imagen y agregado a un informe que fuera parte de uno de nuestros scripts, por ejemplo.</p>
<div class="admonition note">
<p class="first admonition-title">Nota</p>
<p class="last">Cualquier duda o error os podéis poner en contacto con nosotros directamente a través de las <a class="reference external" href="http://www.gvsig.com/es/comunidad/listas-de-correo">Listas de Desarrollo</a></p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/gvsig_asoc.jpg" alt="Logo"/>
            </a></p>
  <h3><a href="../../index.html">Tabla de Contenidos</a></h3>
  <ul>
<li><a class="reference internal" href="#">Taller: Integración de R en gvSIG</a><ul>
<li><a class="reference internal" href="#instalacion">Instalación</a></li>
<li><a class="reference internal" href="#introduccion">Introducción</a></li>
<li><a class="reference internal" href="#comenzando">Comenzando</a></li>
<li><a class="reference internal" href="#estructura-del-proyecto">Estructura del proyecto</a></li>
<li><a class="reference internal" href="#librerias-de-r">Librerías de R</a></li>
<li><a class="reference internal" href="#llamando-funciones-de-r">Llamando funciones de R</a></li>
<li><a class="reference internal" href="#pasando-parametros-a-las-funciones">Pasando parámetros a las funciones</a></li>
<li><a class="reference internal" href="#calculo-de-histograma">Calculo de histograma</a></li>
<li><a class="reference internal" href="#calculo-del-ndvi">Calculo del NDVI</a></li>
</ul>
</li>
</ul>

  <h4>Tema anterior</h4>
  <p class="topless"><a href="../index.html"
                        title="capítulo anterior">Talleres</a></p>
  <h4>Próximo tema</h4>
  <p class="topless"><a href="../../links.html"
                        title="próximo capítulo">Links</a></p>
  <div role="note" aria-label="source link">
    <h3>Esta página</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/workshops/workshop_12gvsig_r/index.rst.txt"
            rel="nofollow">Mostrar el código</a></li>
    </ul>
   </div>
<div id="links"><h3>Links</h3><ul><li><ul style="list-style-type:square">
<li><a href="https://gist.github.com/search?utf8=%E2%9C%93&q=gvsig">Repositorio de Scripts</a></li>
<li><a href="http://downloads.gvsig.org/download/web/scriptcatalog/build/html/">Catálogo de Plugins</a></li></ul></li></ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Búsqueda rápida</h3>
    <gcse:search></gcse:search>
    <p class="searchtip" style="font-size: 90%">
    </p>
</div>
<script>
  (function() {
    var cx = '009725233275570792772:egtqc4l6lsi';
    var gcse = document.createElement('script');
    gcse.type = 'text/javascript';
    gcse.async = true;
    gcse.src = 'https://cse.google.com/cse.js?cx=' + cx;
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gcse, s);
  })();
</script>

<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navegación</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="Índice General"
             >índice</a></li>
        <li class="right" >
          <a href="../../links.html" title="Links"
             >siguiente</a> |</li>
        <li class="right" >
          <a href="../index.html" title="Talleres"
             >anterior</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">documentación de gvSIG Docs - 1.0.0</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Talleres</a> &#187;</li>

<div align="right">
<li>
<a href="http://downloads.gvsig.org/download/web/es/build/html/index.html"><img src="http://downloads.gvsig.org/download/web/pt_br/build/html/_static/flag_ES.png"></a></li>
<a href="http://downloads.gvsig.org/download/web/en/build/html/index.html"><img src="http://downloads.gvsig.org/download/web/pt_br/build/html/_static/flag_EN.png"></a></li>
<a href="http://downloads.gvsig.org/download/web/pt_br/build/html/index.html"><img src="http://downloads.gvsig.org/download/web/pt_br/build/html/_static/flag_BR.png"></a></li>
</div>

      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Derechos de autor 2017, gvSIG association.
      Creado con <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>